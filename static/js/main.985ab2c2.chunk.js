(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{110:function(t,e){},112:function(t,e){},113:function(t,e){},114:function(t,e){},115:function(t,e){},118:function(t,e){},120:function(t,e){},18:function(t,e){function n(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}n.keys=function(){return[]},n.resolve=n,t.exports=n,n.id=18},188:function(t,e,n){},190:function(t,e,n){"use strict";n.r(e);var a=n(0),o=n.n(a),c=n(82),r=n.n(c),s=(n(98),n(90)),i=n(7),l=n(3),u=n(83),d=n(84),f=n(91),p=n(85),h=n(92),m=n(5),g=n(14),b=n(86),j=n.n(b),O=n(34),w=n.n(O),v=n(87),k=n.n(v),E=n(88),y=n.n(E),x=n(35),D=n.n(x),T=n(36),C=n.n(T),S=n(89),F=n.n(S);n(188);w.a.GlobalWorkerOptions.workerSrc="//cdnjs.cloudflare.com/ajax/libs/pdf.js/2.0.943/pdf.worker.js";var _=Object({NODE_ENV:"production",PUBLIC_URL:"/searchworks-collection-plain-texts"}).PROXY||"https://enigmatic-refuge-89957.herokuapp.com/",z=function(t){function e(t){var n;return Object(u.a)(this,e),(n=Object(f.a)(this,Object(p.a)(e).call(this,t))).state={zips:{},status:{},progress:null},n.maxDownloadFiles=10,n.input=o.a.createRef(),n.addTextToZip=n.addTextToZip.bind(Object(m.a)(Object(m.a)(n))),n.downloadZip=n.downloadZip.bind(Object(m.a)(Object(m.a)(n))),n.handleTryOnClick=n.handleTryOnClick.bind(Object(m.a)(Object(m.a)(n))),n.handleDownloadOnClick=n.handleDownloadOnClick.bind(Object(m.a)(Object(m.a)(n))),n}return Object(h.a)(e,t),Object(d.a)(e,[{key:"handleTryOnClick",value:function(t){this.input.current.value=t}},{key:"handleDownloadOnClick",value:function(){var t,e,n=this,a=this.input.current.value,o=Object(g.parse)(a),c=o.hostname,r=o.path;["purl.stanford.edu","searchworks.stanford.edu"].includes(c)&&(this.setState({progress:0,status:Object(l.a)({},[a],"Downloading collection...")}),"purl.stanford.edu"===c?(t=r.slice(1),e="https://searchworks.stanford.edu/catalog.json?f%5Bcollection%5D%5B%5D=".concat(t,"&per_page=").concat(this.maxDownloadFiles)):a.indexOf("searchworks.stanford.edu/catalog.atom")>=0?(t=a.replace("catalog.atom","catalog.json"),e="".concat(t,"&per_page=").concat(this.maxDownloadFiles)):a.indexOf("searchworks.stanford.edu/catalog?")>=0&&(t=a.replace("catalog?","catalog.json?"),e="".concat(t,"&per_page=").concat(this.maxDownloadFiles)),fetch("".concat(_).concat(e),{method:"GET"}).then(function(t){return n.setState({progress:0}),t.json()}).then(function(t){return t.response.docs.flatMap(function(t){return"".concat(t.url_fulltext,"/iiif/manifest")})}).then(function(e){n.setState({status:Object(l.a)({},[a],"Downloading contents...")}),e.forEach(function(e){n.retrieveManifest(t,e)})}),this.input.current.value="")}},{key:"downloadZip",value:function(t){this.state.zips[t].generateAsync({type:"blob"}).then(function(e){y()(e,"".concat(t,".zip"))},function(t){console.log(t)})}},{key:"addTextToZip",value:function(t,e,n){var a=this;this.setState({zips:Object(i.a)(Object(l.a)({},[t],new k.a),this.state.zips),status:Object(i.a)({},this.state.status,Object(l.a)({},[e],"Extracting text..."))}),Promise.all(n.map(function(t){return t.catch(function(t){return t})})).then(function(n){var o=n.map(function(t){return t.text||t}).join(" ");a.setState({progress:a.state.progress+1}),a.state.zips[t].file("".concat(e,".txt"),o),a.setState({status:Object(i.a)({},a.state.status,Object(l.a)({},[e],"Done"))}),a.state.progress===a.maxDownloadFiles&&(a.downloadZip(t),a.setState({progress:null,status:{}}))}).then(function(){a.setState({status:Object(i.a)({},a.state.status,Object(l.a)({},[e],"Adding to zip..."))})}).catch(function(t){return console.log(t)})}},{key:"retrieveManifest",value:function(t,e){var n,a=this;(n=e,fetch("".concat(_).concat(n),{method:"GET"}).then(function(t){return t.json()}).then(function(t){return C.a.create(t).getSequences().map(function(t){return t.getRenderings().map(function(t){return{label:t.options.resource.__jsonld.label,uri:t.id}})})}).then(D.a)).then(function(e){return e.map(function(e){var n=w.a.getDocument("".concat(_).concat(e.uri));return n.onProgress=function(t){var n=t.loaded;t.total;a.setState({status:Object(i.a)({},a.state.status,Object(l.a)({},[e.label],function(t){var e=Math.log(t)/Math.log(1e3)|0;return+(t/Math.pow(1e3,e)).toFixed(2)+" "+("kMGTPEZY"[e-1]||"")+"B"}(n)))})},n.then(function(n){var o=Object(s.a)(Array(n._pdfInfo.numPages).keys()).map(function(t){return a.setState({status:Object(i.a)({},a.state.status,Object(l.a)({},[e.label],"Extractig page ".concat(t+1)))}),n.getPage(t+1).then(function(t){return t.getTextContent().then(function(t){return t.items.map(function(t){return t.str}).join(" ")})})});a.addTextToZip(t,e.label,o)})})}).then(function(n){var o;0===n.length&&(a.setState({status:Object(i.a)({},a.state.status,Object(l.a)({},[e],"No PDFs found. Searching images..."))}),(o=e,fetch("".concat(_).concat(o),{method:"GET"}).then(function(t){return t.json()}).then(function(t){return C.a.create(t).getSequences().map(function(t){return t.getCanvases().map(function(t){return{label:t.__jsonld.label,uri:t.getCanonicalImageUri()}})})}).then(D.a)).then(function(t){return t.map(function(t){var n=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.region,a=void 0===n?"full":n,o=e.size,c=void 0===o?"max":o,r=e.rotation,s=void 0===r?0:r,i=e.quality,l=void 0===i?"default":i,u=t.split("/").slice(0,-4).join("/");return"".concat(u,"/").concat(a,"/").concat(c,"/").concat(s,"/").concat(l,".jpg")}(t.uri,{size:"512,"});return j.a.recognize(n).progress(function(n){var o=n.status,c=n.progress;return a.setState({status:Object(i.a)({},a.state.status,Object(l.a)({},[e],"".concat(o," (").concat(t.label,") ").concat(parseInt(100*c),"%")))})}).then(function(t){return t.text})})}).then(function(n){a.addTextToZip(t,e,n)}))})}},{key:"render",value:function(){var t=this,e=null!==this.state.progress&&this.state.progress!==this.maxDownloadFiles?o.a.createElement("progress",{min:0,max:this.maxDownloadFiles,value:this.state.progress}):"",n=Object.keys(this.state.status).map(function(e,n){return[n?o.a.createElement("dt",{key:"dt".concat(n)},e):o.a.createElement("dt",{key:"dt".concat(n)},o.a.createElement("a",{href:e},e)),o.a.createElement("dd",{key:"dd".concat(n)},t.state.status[e])]}),a=Object.keys(this.state.zips).map(function(e,n){return o.a.createElement("li",{key:"li{idx}"},"Download ",o.a.createElement("button",{href:"#",onClick:function(){return t.downloadZip(e)}},e,".zip"))});return o.a.createElement("div",{className:"App"},o.a.createElement("header",{className:"App-header"},o.a.createElement("img",{src:F.a,className:"App-logo",alt:"logo"}),o.a.createElement("p",null,"To download the available plain texts of a IIIF catalog collection containing PDF or ",o.a.createElement("acronym",{title:"Images will be OCR'ed in the browser using Tesseract (defaults to English)"},"image")," files,",o.a.createElement("br",null),"enter its URL and click on Download (only the first ",o.a.createElement("acronym",{title:"This is only a proof of concept"},"~",this.maxDownloadFiles," items")," will be retrieved)"),o.a.createElement("p",null,o.a.createElement("input",{type:"text",ref:this.input,placeholder:"https://purl.stanford.edu/jt466yc7169"}),o.a.createElement("input",{type:"submit",onClick:this.handleDownloadOnClick,value:"Download"}),o.a.createElement("br",null),o.a.createElement("small",null,"Try the ",o.a.createElement("button",{href:"#",onClick:function(){return t.handleTryOnClick("https://purl.stanford.edu/jt466yc7169")}},"Jarndyce Single-Volume Nineteenth-Century Novel Collection, 1823-1914"),",",o.a.createElement("br",null),"or the ",o.a.createElement("button",{href:"#",onClick:function(){return t.handleTryOnClick("https://searchworks.stanford.edu/catalog?f%5Bcollection%5D%5B%5D=12358426")}},"Racism Lives Here Too Movement records, 2018"),".")),o.a.createElement("div",{className:"App-log"},e,o.a.createElement("dl",null,n),o.a.createElement("ul",null,a))))}}]),e}(a.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));r.a.render(o.a.createElement(z,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(t){t.unregister()})},89:function(t,e,n){t.exports=n.p+"static/media/logo.1e0f9ac8.svg"},93:function(t,e,n){t.exports=n(190)},98:function(t,e,n){}},[[93,2,1]]]);
//# sourceMappingURL=main.985ab2c2.chunk.js.map